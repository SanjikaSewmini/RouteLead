
<!DOCTYPE html>
<html>
<head>
    <title>PayHere Backend Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }
        .debug-info { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .log { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h2>PayHere Backend Test</h2>
        <p>This form will call your backend APIs before submitting to PayHere.</p>
        
        <div class="form-group">
            <label>Test Data:</label>
            <input type="text" id="testData" value='{"orderId":"TEST_1755760003937","amount":"1000.00","currency":"LKR","firstName":"Test","lastName":"User","email":"test@example.com","phone":"0712345678","address":"Test Address","city":"Colombo","country":"Sri Lanka","items":"Test Item"}' readonly>
        </div>
        
        <button onclick="testBackendAPIs()">Test Backend APIs</button>
        <button onclick="testNgrokAPIs()">Test Ngrok APIs</button>
        <button onclick="submitToPayHere()">Submit to PayHere</button>
        
        <div class="log" id="log"></div>
        
        <div class="debug-info">
            <strong>Debug Information:</strong><br>
            <span class="success">✅ This form will call your backend APIs</span><br>
            <span class="success">✅ Check the log above for API responses</span><br>
            <span class="success">✅ Then submit to PayHere with generated data</span><br>
            <br>
            <strong>Test Flow:</strong><br>
            1. Click "Test Backend APIs" to verify backend is working<br>
            2. Click "Test Ngrok APIs" to verify ngrok connection<br>
            3. Click "Submit to PayHere" to test payment flow<br>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += '[' + timestamp + '] ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testBackendAPIs() {
            log('Testing Backend APIs...');
            
            try {
                // Test config API
                log('1. Testing config API...');
                const configResponse = await fetch('http://localhost:8080/api/payments/payhere/config');
                const configResult = await configResponse.json();
                log('Config API Response: ' + JSON.stringify(configResult));
                
                // Test hash generation API
                log('2. Testing hash generation API...');
                const hashResponse = await fetch('http://localhost:8080/api/payments/payhere/generate-hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: 'TEST_1755760003937',
                        amount: '1000.00',
                        currency: 'LKR',
                        first_name: 'Test',
                        last_name: 'User',
                        email: 'test@example.com',
                        phone: '0712345678',
                        address: 'Test Address',
                        city: 'Colombo',
                        country: 'Sri Lanka',
                        items: 'Test Item'
                    })
                });
                const hashResult = await hashResponse.json();
                log('Hash API Response: ' + JSON.stringify(hashResult));
                
                log('✅ Backend APIs tested successfully');
                
            } catch (error) {
                log('❌ Backend API Error: ' + error.message);
            }
        }

        async function testNgrokAPIs() {
            log('Testing Ngrok APIs...');
            
            try {
                const response = await fetch('https://765fb61e0f58.ngrok-free.app/api/payments/payhere/config');
                const result = await response.json();
                log('Ngrok API Response: ' + JSON.stringify(result));
                log('✅ Ngrok APIs tested successfully');
                
            } catch (error) {
                log('❌ Ngrok API Error: ' + error.message);
            }
        }

        async function submitToPayHere() {
            log('Submitting to PayHere...');
            
            try {
                // First get hash from backend
                log('1. Getting hash from backend...');
                const hashResponse = await fetch('http://localhost:8080/api/payments/payhere/generate-hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: 'TEST_1755760003937',
                        amount: '1000.00',
                        currency: 'LKR',
                        first_name: 'Test',
                        last_name: 'User',
                        email: 'test@example.com',
                        phone: '0712345678',
                        address: 'Test Address',
                        city: 'Colombo',
                        country: 'Sri Lanka',
                        items: 'Test Item'
                    })
                });
                const hashResult = await hashResponse.json();
                
                if (hashResult.success) {
                    log('2. Hash generated: ' + hashResult.hash);
                    
                    // Create form data
                    const formData = {
                        merchant_id: '1231712',
                        return_url: 'https://765fb61e0f58.ngrok-free.app/api/payments/return',
                        cancel_url: 'https://765fb61e0f58.ngrok-free.app/api/payments/cancel',
                        notify_url: 'https://765fb61e0f58.ngrok-free.app/api/payments/webhook',
                        first_name: 'Test',
                        last_name: 'User',
                        email: 'test@example.com',
                        phone: '0712345678',
                        address: 'Test Address',
                        city: 'Colombo',
                        country: 'Sri Lanka',
                        order_id: 'TEST_1755760003937',
                        items: 'Test Item',
                        currency: 'LKR',
                        amount: '1000.00',
                        custom_1: 'test-bid-id',
                        custom_2: 'test-request-id',
                        custom_3: 'test-user-id',
                        custom_4: 'CREDIT_CARD',
                        hash: hashResult.hash
                    };
                    
                    log('3. Form data prepared: ' + JSON.stringify(formData));
                    
                    // Submit to PayHere
                    log('4. Submitting to PayHere...');
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = 'https://sandbox.payhere.lk/pay/checkout';
                    form.style.display = 'none';
                    
                    Object.entries(formData).forEach(([key, value]) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    });
                    
                    document.body.appendChild(form);
                    form.submit();
                    
                } else {
                    log('❌ Hash generation failed: ' + hashResult.message);
                }
                
            } catch (error) {
                log('❌ Submit Error: ' + error.message);
            }
        }
    </script>
</body>
</html>